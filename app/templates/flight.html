<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flight Dashboard</title>
    <script>
        const flightId = {{ flight.id }};
        const flightStatus = "{{ flight.status }}";

        function updateTime() {
            const now = new Date();
            document.getElementById("utc-time").textContent = now.toUTCString().split(" ")[4];
            document.getElementById("local-time").textContent = now.toTimeString().split(" ")[0];
        }
        setInterval(updateTime, 1000);
        window.onload = updateTime;
        function updateTelemetry() {
            fetch('/api/telemetry')
                .then(response => response.json())
                .then(data => {
                    for (const [key, value] of Object.entries(data)) {
                        const element = document.getElementById(key);
                        if (element) element.textContent = value;
                    }
                });
        }

        // Fetch every second
        setInterval(updateTelemetry, 2000);
        updateTelemetry();

        document.addEventListener('DOMContentLoaded', function () {
        const calibrateBtn = document.getElementById('calibrateBtn');
        const calibrateStatus = document.getElementById('calibrateStatus');

        // Disable button if flight has already started
        if (flightStatus !== 'pre-flight') {
            calibrateBtn.disabled = true;
            calibrateStatus.textContent = "Calibration disabled: Flight already started.";
        }

        calibrateBtn.addEventListener('click', function () {
            calibrateStatus.textContent = "Calibrating... please wait.";
            calibrateBtn.disabled = true;

            setTimeout(() => {
                fetch(`/flight/${flightId}/calibrate`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            calibrateStatus.textContent = `Error: ${data.error}`;
                        } else {
                            calibrateStatus.textContent = "Calibration successful.";
                        }
                        if (flightStatus === 'pre-flight') {
                            calibrateBtn.disabled = false; // allow re-calibration
                        }
                    })
                    .catch(err => {
                        calibrateStatus.textContent = "Request failed.";
                        console.error("Calibration error:", err);
                        calibrateBtn.disabled = false;
                    });
            }, Math.random() * 3000 + 2000);  // 2â€“5 seconds wait
        });
    });

    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" /><link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">    
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
    <div class="section header">
        <table>
            <tr>
                <th>Mission #</th>
                <td id="mission-number">{{ flight.mission_number }}</td>
                <th>Equipment</th>
                <td id="equipment">{{ flight.equipment }}</td>
            </tr>
            <tr>
                <th>Start Time</th>
                <td id="start-time">{{ flight.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <th>Date</th>
                <td id="date">{{ flight.start_time.strftime('%Y-%m-%d') }}</td>
            </tr>
        </table>
        <table>
            <tr>
                <th>UTC</th>
                <td id="utc-time">--:--:--</td>
            </tr>
            <tr>
                <th>Local</th>
                <td id="local-time">--:--:--</td>
            </tr>
        </table>
    </div>
    <div class="section main">
        <div>
            <div class="profile-wrapper">
                <div class="scale">
                    <div>100 mb</div>
                    <div>200</div>
                    <div>300</div>
                    <div>400</div>
                    <div>500</div>
                    <div>600</div>
                    <div>700</div>
                    <div>800</div>
                    <div>900</div>
                    <div>1000 mb</div>
                </div>
                <div class="profile">
                    <div class="balloon" id="balloon" style="bottom: {{ balloon_position or 80 }}%">ðŸŽˆ</div>
                    <div class="parachute" id="parachute" style="bottom: {{ parachute_position or 60 }}%">ðŸª‚</div>
                    <div class="balloon" id="burst" style="bottom: {{ burst_position or 0 }}%">ðŸ’¥</div>
                </div>
            </div>
            <table>
                <tr><th>Temp</th><td id="temp">{{ telemetry.temperature or "N/A" }}</td></tr>
                <tr><th>Dew Point</th><td id="dew-point">{{ telemetry.dew_point or "N/A" }}</td></tr>
                <tr><th>Pressure</th><td id="pressure">{{ telemetry.pressure or "N/A" }}</td></tr>
                <tr><th>GPS Altitude</th><td id="gps-altitude">{{ telemetry.gps_altitude or "N/A" }}</td></tr>
                <tr><th>Altitude Î”</th><td id="altitude-delta">{{ telemetry.altitude_delta or "N/A" }}</td></tr>
                <tr><th>Peak Altitude</th><td id="peak-altitude">{{ telemetry.peak_altitude or "N/A" }}</td></tr>
                <tr><th>Peak Speed</th><td id="peak-speed">{{ telemetry.peak_speed or "N/A" }}</td></tr>
            </table>
        </div>

        <div>
        <div class="mission-control-buttons">
            <button>Start</button>
            <button>Abort</button>
            <button id="calibrateBtn" class="btn btn-warning">Calibrate Ground</button>
            <p id="calibrateStatus" style="margin-top: 5px; font-size: 0.9em;"></p>

        </div>
        
        <div class="hardware-metrics">
            <strong>Hardware Metrics</strong>
            <table>
                <tr><th>CPU Temp</th><td id="cpu-temp">{{ telemetry.cpu_temperature or "N/A" }}</td></tr>
                <tr><th>Battery</th><td id="battery">{{ telemetry.battery or "N/A" }}</td></tr>
                <tr><th>Voltage</th><td id="voltage">{{ telemetry.voltage or "N/A" }}</td></tr>
                <tr><th>Signal Strength</th><td id="signal-strength">{{ telemetry.signal_strength or "N/A" }}</td></tr>
            </table>
        </div>
        
        <div class="flight-params">
            <strong>Flight Parameters</strong>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Expected</th>
                        <th>Actual</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Expected Ascent Rate</th>
                        <td id="expected-ascent">{{ flight.expected_ascent_rate or "N/A" }}</td>
                        <td id="actual-ascent">{{ telemetry.ascent_rate or "N/A" }}</td>
                    </tr>
                    <tr>
                        <th>Helium Volume</th>
                        <td id="helium-volume">{{ flight.expected_helium_volume or "N/A" }}</td>
                        <td id="actual-helium-volume">{{ telemetry.helium_volume or "N/A" }}</td>
                    </tr>
                    <tr>
                        <th>Burst Altitude</th>
                        <td id="burst-altitude">{{ flight.expected_burst_altitude or "N/A" }}</td>
                        <td id="actual-burst-altitude">{{ telemetry.burst_altitude or "N/A" }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

    <div class="section footer">
        <h2>GPS Profile</h2>
        <div id="map" style="width: 100%; height: 300px; border: 1px solid black;"></div>

        <script>
            let pathLayer;
            // Center on a default location until we fetch real data:
            const map = L.map('map').setView([0, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            function updateGPS() {
                const fld = {{ flight.id }};
                fetch(`/api/gps/${fld}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data || data.length === 0) {
                            // no points; you might want to show a â€œNo GPS yetâ€ message
                            return;
                        }

                        // Remove old path if it exists
                        if (pathLayer) map.removeLayer(pathLayer);

                        // Extract just the [lat,lng] pairs
                        const pathCoords = data.map(point => point.coords);

                        // Draw the polyline
                        pathLayer = L.polyline(pathCoords, { color: 'blue', weight: 3 }).addTo(map);

                        // Place markers (optional)
                        data.forEach((point, index) => {
                            const marker = L.marker(point.coords)
                                .addTo(map)
                                .bindPopup(`Point ${index+1}<br>Alt: ${point.altitude} m<br>Time: ${point.timestamp}`);
                            if (index === data.length - 1) {
                                marker.openPopup();
                            }
                        });

                        // Fit map bounds
                        map.fitBounds(pathLayer.getBounds());
                    });
            }

            // Update every 5 seconds
            setInterval(updateGPS, 5000);
            updateGPS();
        </script>
    </div>
    <div class="section status">
    <div>
        <h2>Status</h2>
        <table>
            <tr><th>Status</th><td id="mission-status">{{ flight.status or "N/A" }}</td></tr>
            <tr><th>Telecom</th><td id="telecom-status">{{ telemetry.telecom_status or "N/A" }}</td></tr>
            <tr><th>Last Heard</th><td id="last-heard">{{ telemetry.last_heard or "N/A" }}</td></tr>
        </table>
    </div>
    <div class="alert-panel">
        <div class="alert-column">
            <div class="alert {{ 'green-lit' if telemetry.alt_ok else 'green-unlit' }}" id="alert-alt-ok">ALT OK</div>
            <div class="alert {{ 'green-lit' if telemetry.gps_ready else 'green-unlit' }}" id="alert-gps-ready">GPS READY</div>
            <div class="alert {{ 'green-lit' if telemetry.battery_ok else 'green-unlit' }}" id="alert-battery">BATTERY</div>
        </div>
        <div class="alert-column">
            <div class="alert {{ 'orange-lit' if telemetry.temp_warn else 'orange-unlit' }}">TEMP WARN</div>
            <div class="alert {{ 'orange-lit' if telemetry.signal_low else 'orange-unlit' }}">SIGNAL LOW</div>
        </div>
        <div class="alert-column">
            <div class="alert {{ 'red-lit' if telemetry.fail_safe else 'red-unlit' }}">FAIL SAFE</div>
            <div class="alert {{ 'red-lit' if telemetry.tx_fail else 'red-unlit' }}">TX FAIL</div>
            <div class="alert {{ 'red-lit' if telemetry.low_power else 'red-unlit' }}">LOW PWR</div>
        </div>
    </div>
    <div class="log" id="log-container">
        <strong>Log:</strong>
        <ul id="log-entries">
            {% for log in logs %}
                <li>{{ log.message }}</li>
            {% endfor %}
        </ul>
    </div>
</div>

</body>
</html>
