<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flight Dashboard</title>
    <script>
        const flightId = {{ flight.id }};
        const flightStatus = "{{ flight.status }}";

        function updateTime() {
            const now = new Date();
            document.getElementById("utc-time").textContent = now.toUTCString().split(" ")[4];
            document.getElementById("local-time").textContent = now.toTimeString().split(" ")[0];
        }
        setInterval(updateTime, 1000);
        window.onload = updateTime;

        function updateTelemetry() {
          fetch(`/api/telemetry/${flightId}`)
            .then(r => r.json())
            .then(data => {
              Object.entries(data).forEach(([key, value]) => {
                const el = document.getElementById(key);
                if (el) el.textContent = value;
              });
            })
            .catch(console.error);
        }

        setInterval(updateTelemetry, 2000);
        updateTelemetry();

        document.addEventListener('DOMContentLoaded', function () {
        const flightId = {{ flight.id }};
        const flightStatus = "{{ flight.status }}";

        // Calibrate button
        const calibrateBtn = document.getElementById('calibrateBtn');
        const calibrateStatus = document.getElementById('calibrateStatus');

        if (flightStatus !== 'pre-flight') {
            calibrateBtn.disabled = true;
            calibrateStatus.textContent = "Calibration disabled: Flight already started.";
        }

        calibrateBtn.addEventListener('click', function () {
            calibrateStatus.textContent = "Calibrating... please wait.";
            calibrateBtn.disabled = true;

            setTimeout(() => {
                fetch(`/flight/${flightId}/calibrate`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            calibrateStatus.textContent = `Error: ${data.error}`;
                        } else {
                            calibrateStatus.textContent = "Calibration successful.";
                        }
                        if (flightStatus === 'pre-flight') {
                            calibrateBtn.disabled = false;
                        }
                    })
                    .catch(err => {
                        calibrateStatus.textContent = "Request failed.";
                        console.error("Calibration error:", err);
                        calibrateBtn.disabled = false;
                    });
            });
        });

        // Release button
        const releaseBtn = document.getElementById('releaseBtn');
        const releaseStatus = document.getElementById('releaseStatus');

        if (flightStatus !== 'pre-flight') {
            releaseBtn.disabled = true;
            releaseStatus.textContent = "Release disabled: Already in flight or ended.";
        }

        releaseBtn.addEventListener('click', function () {
            releaseStatus.textContent = "Releasing sonde...";
            releaseBtn.disabled = true;

            fetch(`/flight/${flightId}/release`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        releaseStatus.textContent = `Error: ${data.error}`;
                        releaseBtn.disabled = false;
                    } else {
                        releaseStatus.textContent = `Sonde released at ${data.release_ts}`;
                        document.getElementById('calibrateBtn').disabled = true;
                    }
                })
                .catch(err => {
                    releaseStatus.textContent = "Release failed.";
                    console.error(err);
                    releaseBtn.disabled = false;
                });
        });

        // End button
        const endFlightBtn = document.getElementById('endFlightBtn');
        const endStatus = document.getElementById('endStatus');

        if (flightStatus === 'post-flight') {
            endFlightBtn.disabled = true;
            endStatus.textContent = "Flight is already ended.";
        }

        endFlightBtn.addEventListener('click', function () {
            if (!confirm("Are you sure you want to end this flight? This action is final.")) return;

            endStatus.textContent = "Ending flight...";
            endFlightBtn.disabled = true;

            fetch(`/flight/${flightId}/end`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        endStatus.textContent = `Error: ${data.error}`;
                        endFlightBtn.disabled = false;
                    } else {
                        endStatus.textContent = "Flight successfully ended.";
                        document.getElementById('calibrateBtn')?.setAttribute('disabled', 'true');
                        document.getElementById('releaseBtn')?.setAttribute('disabled', 'true');
                    }
                })
                .catch(err => {
                    endStatus.textContent = "Failed to end flight.";
                    console.error(err);
                    endFlightBtn.disabled = false;
                });
        });

        function updateStatus() {
          fetch(`/api/status/${flightId}`)
            .then(r => r.json())
            .then(s => {
              const balloon   = document.getElementById('balloon');
              const burst     = document.getElementById('burst');
              const parachute = document.getElementById('parachute');
              function setElement(el, pct) {
                if (pct == null) {
                  el.style.display = 'none';
                } else {
                  el.style.display = '';
                  el.style.bottom  = pct + '%';
                }
              }
              setElement(balloon,   s.balloon_position);
              setElement(burst,     s.burst_position);
              setElement(parachute, s.parachute_position);
            })
            .catch(console.error);
        }

        // run it every 2 s
        setInterval(updateStatus, 2000);
        updateStatus();




        function updateLogs() {
            fetch(`/api/logs/${flightId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.logs || data.logs.length === 0) return;

                    const logTableBody = document.querySelector("#log-entries tbody");
                    if (!logTableBody) return;

                    logTableBody.innerHTML = "";

                    data.logs.forEach(log => {
                        const row = document.createElement("tr");

                        const ts = document.createElement("td");
                        const date = new Date(log.timestamp);
                        ts.textContent = date.toISOString().split("T")[1].split(".")[0] + " UTC";
                        row.appendChild(ts);

                        const level = document.createElement("td");
                        level.innerHTML = `<span class="log-level log-${log.level.toLowerCase()}">${log.level}</span>`;
                        row.appendChild(level);

                        const msg = document.createElement("td");
                        msg.textContent = log.message;
                        row.appendChild(msg);

                        logTableBody.appendChild(row);
                    });
                });
        }

        setInterval(updateLogs, 5000);
        updateLogs();
    });


    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" /><link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
    <div class="section header">
        <table>
            <tr>
                <th>Mission #</th>
                <td id="mission-number">{{ flight.mission_number }}</td>
                <th>Equipment</th>
                <td id="equipment">{{ flight.equipment }}</td>
            </tr>
            <tr>
                <th>Start Time</th>
                <td id="start-time">{{ flight.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <th>Date</th>
                <td id="date">{{ flight.start_time.strftime('%Y-%m-%d') }}</td>
            </tr>
        </table>

        <table>
            <tr>
                <th>UTC</th>
                <td id="utc-time">--:--:--</td>
            </tr>
            <tr>
                <th>Local</th>
                <td id="local-time">--:--:--</td>
            </tr>
        </table>
    </div>
    <div class="section main">
        <div>
            <div class="profile-wrapper">
                <div class="scale">
                    <div>100 mb</div>
                    <div>200</div>
                    <div>300</div>
                    <div>400</div>
                    <div>500</div>
                    <div>600</div>
                    <div>700</div>
                    <div>800</div>
                    <div>900</div>
                    <div>1000 mb</div>
                </div>
                <div class="profile">
                    <div class="balloon" id="balloon">ðŸŽˆ</div>
                    <div class="parachute" id="parachute">ðŸª‚</div>
                    <div class="baloon" id="burst">ðŸ’¥</div>
                </div>
            </div>
            <table>
                <tr><th>Temp</th><td id="temp">{{ telemetry.temperature or "N/A" }}</td></tr>
                <tr><th>Humidity</th><td id="humidity">{{ telemetry.humidity or "N/A" }}</td></tr>
                <tr><th>Pressure</th><td id="pressure">{{ telemetry.pressure or "N/A" }}</td></tr>
                <tr><th>Speed</th><td id="speed">{{ telemetry.speed or "N/A" }}</td></tr>
                <tr><th>GPS Altitude</th><td id="gps-altitude">{{ telemetry.gps_altitude or "N/A" }}</td></tr>
                <tr><th>Altitude Î”</th><td id="altitude-delta">{{ telemetry.altitude_delta or "N/A" }}</td></tr>
                <tr><th>Peak Altitude</th><td id="peak-altitude">{{ telemetry.peak_altitude or "N/A" }}</td></tr>
            </table>
        </div>

        <div>
        <div class="mission-control-buttons">
            <button id="calibrateBtn" class="btn btn-warning">Calibrate Ground</button>
            <p id="calibrateStatus" style="margin-top: 5px; font-size: 0.9em;"></p>
            <button id="releaseBtn" class="btn btn-danger">Release Sonde</button>
            <p id="releaseStatus" style="margin-top: 5px; font-size: 0.9em;"></p>
            <button id="endFlightBtn" class="btn btn-dark">End Flight</button>
            <p id="endStatus" style="margin-top: 5px; font-size: 0.9em;"></p>


        </div>

        <div class="hardware-metrics">
            <strong>Hardware Metrics</strong>
            <table>
                <tr><th>Signal Strength</th><td id="signal-strength">{{ telemetry.signal_strength or "N/A" }}</td></tr>
            </table>
        </div>

        <div class="flight-params">
            <strong>Flight Parameters</strong>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Expected</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Expected Ascent Rate</th>
                        <td id="expected-ascent">{{ flight.expected_ascent_rate or "N/A" }}</td>
                    </tr>
                    <tr>
                        <th>Helium Volume</th>
                        <td id="helium-volume">{{ flight.expected_helium_volume or "N/A" }}</td>
                    </tr>
                    <tr>
                        <th>Burst Altitude</th>
                        <td id="burst-altitude">{{ flight.expected_burst_altitude or "N/A" }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

    <div class="section footer">
        <h2>GPS Profile</h2>
        <div id="map" style="width: 100%; height: 300px; border: 1px solid black;"></div>

        <script>
            let pathLayer;
            // Center on a default location until we fetch real data:
            const map = L.map('map').setView([0, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            const markerLayer = L.layerGroup().addTo(map);

            function updateGPS() {
              const fld = {{ flight.id }};
              fetch(`/api/gps/${fld}`)
                .then(res => res.json())
                .then(data => {
                  if (!data || data.length === 0) return;

                  if (pathLayer) {
                    map.removeLayer(pathLayer);
                    pathLayer = null;
                  }
                  markerLayer.clearLayers();

                  // Draw full polyline anyway
                  const pathCoords = data.map(pt => pt.coords);
                  pathLayer = L.polyline(pathCoords, { color: 'blue', weight: 3 }).addTo(map);

                  data.forEach(pt => {
                    // choose icon
                    let marker;
                    if (pt.icon === 'start') {
                      marker = L.marker(pt.coords, { title: "Launch" })
                                .bindPopup(`Launch @ ${pt.timestamp}`);
                    }
                    else if (pt.icon === 'burst') {
                      marker = L.marker(pt.coords, { title: "Burst" })
                                .bindPopup(`Burst @ ${pt.timestamp}`);
                    }
                    else if (pt.icon === 'end') {
                      marker = L.marker(pt.coords, { title: "Latest" })
                                .bindPopup(`Latest @ ${pt.timestamp}`);
                    }
                    else {
                      // small circle without icon
                      marker = L.circleMarker(pt.coords, { radius: 3 });
                    }
                    markerLayer.addLayer(marker);

                    // open only start, burst, end
                    if (pt.icon) marker.openPopup();
                  });

                  map.fitBounds(pathLayer.getBounds());
                })
                .catch(console.error);
            }

            // Update every 5 seconds
            setInterval(updateGPS, 5000);
            updateGPS();
        </script>
    </div>
    <div class="section status">
    <div>
        <h2>Status</h2>
        <table>
            <tr><th>Status</th><td id="mission-status">{{ flight.status or "N/A" }}</td></tr>
            <tr><th>Telecom</th><td id="telecom-status">{{ telemetry.telecom_status or "N/A" }}</td></tr>
            <tr><th>Last Heard</th><td id="last-heard">{{ telemetry.last_heard or "N/A" }}</td></tr>
        </table>
    </div>
    <div class="alert-panel">
      <div class="alert-column">
        <div id="alert-receiver"   class="alert green-unlit">RECEIVER</div>
        <div id="alert-parser"     class="alert green-unlit">PARSER</div>
        <div id="alert-sensor"     class="alert green-unlit">SENSOR</div>
      </div>
      <div class="alert-column">
        <div id="alert-signal"     class="alert green-unlit">SIGNAL</div>
        <div id="alert-packet"     class="alert green-unlit">PACKET</div>
        <div id="alert-age"        class="alert green-unlit">AGE</div>
      </div>
      <div class="alert-column">
        <div id="alert-calibrated" class="alert green-unlit">CALIBRATED</div>
        <div id="alert-burst"      class="alert green-unlit">BURST</div>
        <div id="alert-temp-low"   class="alert green-unlit">TEMP LOW</div>
      </div>
      <div class="alert-column">
        <div id="alert-data-degrad" class="alert green-unlit">MEAS DEGRAD</div>
        <div id="alert-gps-fix"     class="alert green-unlit">GPS FIX</div>
        <div id="alert-gps-degrad"  class="alert green-unlit">GPS DEGRAD</div>
      </div>
    </div>
    <div class="log-panel">
        <table class="log-table" id="log-entries">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Level</th>
                    <th>Message</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td><span class="log-level log-{{ log.level|lower }}">{{ log.level }}</span></td>
                    <td>{{ log.message }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>

</div>

</body>
</html>